<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Video Composesser™</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body {
    background: #2a2a2a;
    color: #ddd;
    font-family: system-ui, sans-serif;
    text-align: center;
    padding: 16px;
  }

  button, input {
    margin-top: 12px;
    font-size: 1em;
  }

  canvas {
    display: none;
  }

  video {
    margin-top: 16px;
    width: 320px;
    image-rendering: pixelated;
  }
</style>
</head>

<body>

<h2>Video Composesser™</h2>
<p>Intentionally ruins video. No frame. No mercy.</p>

<input type="file" id="file" accept="video/*"><br>
<button onclick="composess()">Composess</button>

<video id="preview" controls></video>
<canvas id="c"></canvas>

<script>
const fileInput = document.getElementById("file");
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
const preview = document.getElementById("preview");

function composess() {
  const file = fileInput.files[0];
  if (!file) return alert("give me a video");

  const video = document.createElement("video");
  video.src = URL.createObjectURL(file);
  video.muted = true;
  video.play();

  video.onloadedmetadata = () => {
    const tinyW = 160;
    const tinyH = Math.floor(tinyW * (video.videoHeight / video.videoWidth));

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const tiny = document.createElement("canvas");
    tiny.width = tinyW;
    tiny.height = tinyH;
    const tctx = tiny.getContext("2d");

    const stream = canvas.captureStream(12);
    const recorder = new MediaRecorder(stream, { mimeType: "video/webm" });
    const chunks = [];

    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = () => {
      const blob = new Blob(chunks, { type: "video/webm" });
      const url = URL.createObjectURL(blob);
      preview.src = url;

      const a = document.createElement("a");
      a.href = url;
      a.download = "video_composessed.webm";
      a.click();
    };

    recorder.start();

    function draw() {
      if (video.paused || video.ended) {
        recorder.stop();
        return;
      }

      // draw tiny
      tctx.drawImage(video, 0, 0, tinyW, tinyH);

      // upscale brutally
      ctx.imageSmoothingEnabled = false;
      ctx.drawImage(tiny, 0, 0, canvas.width, canvas.height);

      // slight blur pass
      ctx.globalAlpha = 0.25;
      ctx.drawImage(canvas, 1, 0);
      ctx.globalAlpha = 1;

      // color crush
      let img = ctx.getImageData(0, 0, canvas.width, canvas.height);
      let d = img.data;

      for (let i = 0; i < d.length; i += 4) {
        d[i]     = Math.floor(d[i] / 64) * 64;
        d[i + 1] = Math.floor(d[i + 1] / 64) * 64;
        d[i + 2] = Math.floor(d[i + 2] / 64) * 64;
      }

      ctx.putImageData(img, 0, 0);
      requestAnimationFrame(draw);
    }

    draw();
  };
}
</script>

</body>
</html>
