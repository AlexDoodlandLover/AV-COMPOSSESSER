<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Video Composesser‚Ñ¢</title>
<style>
  body {
    background: #1f140a;
    color: #f3deb3;
    font-family: monospace;
    text-align: center;
    padding: 16px;
  }
  canvas { display: none; }
  button { padding: 12px 18px; margin-top: 12px; }
</style>
</head>

<body>
<h2>üéûÔ∏è Video Composesser‚Ñ¢</h2>
<p>Now 100% FFmpeg-free.</p>

<input type="file" id="file" accept="video/*"><br>
<button onclick="composess()">Composess</button>

<canvas id="c"></canvas>

<script>
const fileInput = document.getElementById("file");
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

const ua = navigator.userAgent;
const isIOS = /iPhone|iPad|iPod/i.test(ua);
const isAndroid = /Android/i.test(ua);

function composess() {
  const file = fileInput.files[0];
  if (!file) return alert("give me a video");

  const video = document.createElement("video");
  video.src = URL.createObjectURL(file);
  video.muted = true;
  video.play();

  video.onloadedmetadata = () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const stream = canvas.captureStream(12);
    const recorder = new MediaRecorder(stream, { mimeType: "video/webm" });
    const chunks = [];

    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = () => {
      const blob = new Blob(chunks, { type: "video/webm" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "video_composessed.webm";
      a.click();
    };

    recorder.start();

    function draw() {
      if (video.paused || video.ended) {
        recorder.stop();
        return;
      }

      // base draw
      const scale = isIOS ? 4 : isAndroid ? 6 : 8;
      ctx.drawImage(video, 0, 0, canvas.width/scale, canvas.height/scale);
      ctx.drawImage(canvas, 0, 0, canvas.width, canvas.height);

      let img = ctx.getImageData(0,0,canvas.width,canvas.height);
      let d = img.data;

      for (let i = 0; i < d.length; i += 4) {
        if (isIOS) {
          d[i] = Math.min(255, d[i] * 1.1);
          d[i+1] *= 0.9;
        } else if (isAndroid) {
          d[i] = Math.floor(d[i] / 48) * 48;
        } else {
          d[i] = d[i+4] || d[i];
        }
      }

      ctx.putImageData(img,0,0);
      requestAnimationFrame(draw);
    }

    draw();
  };
}
</script>
</body>
</html>
